name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # ← Add this line

env:
  PYTHON_VERSION: "3.11"

jobs:
  # Detect which parts of the codebase changed
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      modal: ${{ steps.filter.outputs.modal }}
      backend: ${{ steps.filter.outputs.backend }}
      migrations: ${{ steps.filter.outputs.migrations }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            modal:
              - 'backend/modal_runtime/**'
            backend:
              - 'backend/**'
              - 'requirements.txt'
            migrations:
              - 'backend/db/alembic/versions/**'
              - 'backend/db/models.py'
            frontend:
              - 'frontend/**'
              - 'package.json'

  # Test Modal sandbox and driver (functions are deprecated, use executor.execute() instead)
  test-modal:
    name: Test Modal Sandbox & Driver
    needs: detect-changes
    if: needs.detect-changes.outputs.modal == 'true' || needs.detect-changes.outputs.backend == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Test Modal driver (local, no S3)
        run: |
          echo "Testing Modal driver locally..."
          pytest backend/modal_runtime/tests/test_driver_e2e.py backend/modal_runtime/tests/test_driver_artifacts.py -v --tb=short
        env:
          S3_DISABLE_UPLOAD: "1"
      
      - name: Deploy Modal app (updates driver.py in Modal image)
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          echo "Deploying Modal app to update driver.py..."
          modal deploy backend/modal_runtime/app.py
      
      - name: Test Modal sandbox executor (requires Modal tokens)
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          echo "Testing Modal sandbox executor..."
          pytest backend/modal_runtime/tests/test_sandbox.py -v --tb=short -s
      
      - name: Test sandbox tools (integration tests with executor.execute)
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          echo "Testing sandbox tools (load, list, export datasets)..."
          pytest tests/tools/test_sandbox_tools.py tests/tools/test_load_to_sandbox.py tests/tools/test_export_from_sandbox.py -v --tb=short

  # Test database migrations with Docker Postgres
  test-migrations:
    name: Test Database Migrations
    needs: detect-changes
    if: needs.detect-changes.outputs.migrations == 'true' || needs.detect-changes.outputs.backend == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # Start Docker Compose with the infra setup
      - name: Create Docker network
        run: docker network create langgraph-network || true
      
      - name: Start Postgres with Docker Compose
        run: |
          cd infra
          docker compose up -d db
          
      - name: Wait for Postgres to be ready
        run: |
          echo "Waiting for Postgres..."
          for i in {1..30}; do
            if docker exec chat_pg pg_isready -U postgres; then
              echo "Postgres is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
      
      - name: Run migrations
        env:
          ALEMBIC_DATABASE_URL: postgresql+psycopg2://postgres:postgres@localhost:5432/chat
        run: |
          echo "Running Alembic migrations..."
          alembic upgrade head
          alembic current
      
      - name: Test migration rollback/upgrade cycle
        env:
          ALEMBIC_DATABASE_URL: postgresql+psycopg2://postgres:postgres@localhost:5432/chat
        run: |
          echo "Testing migration cycle..."
          # Get current revision
          CURRENT=$(alembic current | grep -oP '(?<=^)[a-f0-9]+' | head -1)
          echo "Current revision: $CURRENT"
          
          # Only test downgrade if we have a revision and it's not base
          if [ ! -z "$CURRENT" ] && [ "$CURRENT" != "base" ]; then
            echo "Testing downgrade to base and upgrade back to head..."
            alembic downgrade base
            alembic upgrade head
            echo "✅ Migration cycle successful (full down/up)"
          else
            echo "✅ At base or no migrations, skipping downgrade test"
          fi
      
      - name: Cleanup
        if: always()
        run: |
          cd infra
          docker compose down -v

  # Test API endpoints
  test-api:
    name: Test API Endpoints
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create Docker network
        run: docker network create langgraph-network || true
      
      - name: Start Postgres with Docker Compose
        run: |
          cd infra
          docker compose up -d db
      
      - name: Wait for Postgres to be ready
        run: |
          echo "Waiting for Postgres..."
          for i in {1..30}; do
            if docker exec chat_pg pg_isready -U postgres; then
              echo "Postgres is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
      
      - name: Run migrations
        env:
          ALEMBIC_DATABASE_URL: postgresql+psycopg2://postgres:postgres@localhost:5432/chat
        run: alembic upgrade head
      
      - name: Run API tests
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/chat
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        run: |
          echo "Running API health checks..."
          pytest tests/api/ -v --tb=short
      
      - name: Cleanup
        if: always()
        run: |
          cd infra
          docker compose down -v

  # Lint code (find bugs and code quality issues)
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install linting tools
        run: pip install ruff
      
      - name: Run ruff
        run: ruff check backend/

  # Test frontend build and types
  test-frontend:
    name: Test Frontend
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
      
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Run TypeScript type check
        working-directory: frontend
        run: npx tsc --noEmit
      
      - name: Run ESLint
        working-directory: frontend
        run: npx eslint . --ext ts,tsx --report-unused-disable-directives
      
      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          # Provide dummy env vars for build (Railway will provide real ones)
          VITE_API_URL: http://localhost:8000/api
          VITE_CLERK_PUBLISHABLE_KEY: pk_test_dummy

  # NOTE: Modal functions deployment removed
  # The functions in backend/modal_runtime/functions.py are DEPRECATED.
  # They are no longer used in production - we use executor.execute() instead.
  # See backend/modal_runtime/functions.py for full explanation.
  #
  # If you need to deploy Modal apps (e.g., app.py for sandbox executor),
  # add a new job here that deploys the specific app you need.

